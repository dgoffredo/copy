#!/bin/sh

set -e

if [ $# -ne 3 ]; then
    >&2 echo "usage: $0 <block_size> \"x\" <num_blocks>"
    >&2 echo
    >&2 echo "example: $0 10M x 3"
    >&2 echo
    >&2 echo "creates a 30 mebibyte file named \"var/input-file\"",
    >&2 echo "deletes \"var/output-file\", and drops I/O caches."
    exit 1
fi

block_size=$1
num_blocks=$3

var=$(dirname "$0")/../var

rm -f "$var/input-file" "$var/output-file"
2>/dev/null dd if=/dev/zero of="$var/input-file" "bs=$block_size" "count=$num_blocks"

if ! [ -e "$var/response.fifo" ]; then
    mkfifo "$var/response.fifo"
fi
echo "$var/response.fifo" >"$var/drop_caches.fifo"
cat "$var/response.fifo" >/dev/null
